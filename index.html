<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Nota de Marmitas</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body class="bg-gray-100 text-gray-800 font-sans">

  <div class="w-full min-h-screen p-4 flex justify-center">
    <div class="w-full max-w-2xl bg-white p-6 space-y-6 rounded-lg shadow">
      <h1 class="text-3xl font-extrabold text-center text-orange-600">Nota das Marmitas</h1>

      <!-- Cliente -->
      <div>
        <h3 class="text-lg font-semibold mb-2">Dados do Cliente</h3>
        <input id="clienteNome" placeholder="Nome do Cliente" 
               class="w-full border border-gray-300 rounded-lg px-4 py-2 shadow-sm focus:ring-2 focus:ring-orange-400 focus:outline-none">
      </div>

      <!-- Produto -->
      <div>
        <h3 class="text-lg font-semibold mb-2">Produto</h3>
        <div class="grid grid-cols-1 gap-3 md:grid-cols-4">
  <!-- Nome do produto -->
  <select id="produtoNome" onchange="preencherValor()"
          class="w-full md:col-span-2 border border-gray-300 rounded-lg px-3 py-2 shadow-sm focus:ring-2 focus:ring-orange-400 focus:outline-none">
    <option value="AlmÃ´ndega" data-valor="5.50">AlmÃ´ndega de tofu</option>
    <option value="AlmÃ´ndega Bovina" data-valor="7.00">AlmÃ´ndega Bovina</option>
    <option value="Caril de frango" data-valor="6.50">Caril de frango</option>
    <option value="Caril de Legumes" data-valor="5.50">Caril de legumes</option>
    <option value="Lentilha" data-valor="5.50">Lentilha</option>
    <option value="Peru" data-valor="6.50">Peru</option>
    <option value="Strogonoff" data-valor="5.50">Strogonoff</option>
    <option value="Strogonoff de Frango" data-valor="6.50">Strogonoff de frango</option>
    <option value="Parmegiana" data-valor="5.50">Parmegiana</option>
    <option value="Panqueca" data-valor="5.50">Panqueca</option>
  </select>

  <!-- Quantidade -->
  <input id="produtoQtd" placeholder="Qtd" type="number"
        class="w-full md:col-span-1 border border-gray-300 rounded-lg px-3 py-2 shadow-sm focus:ring-2 focus:ring-orange-400 focus:outline-none">

  <!-- Valor -->
  <input id="produtoValor" placeholder="Valor (â‚¬)" type="number" step="0.01"
        class="w-full md:col-span-1 border border-gray-300 rounded-lg px-3 py-2 shadow-sm focus:ring-2 focus:ring-orange-400 focus:outline-none">

  <!-- BotÃ£o -->
  <button onclick="adicionarProduto()" 
          class="w-full md:col-span-1 bg-orange-500 text-white font-medium rounded-lg shadow px-4 py-2 hover:bg-orange-600 transition">
    +
  </button>
</div>

      </div>

      <!-- Tabela -->
      <div class="overflow-x-auto">
        <table id="tabelaProdutos" class="w-full text-sm border border-gray-200 rounded-lg overflow-hidden">
          <thead class="bg-orange-100 text-gray-700">
            <tr>
              <th class="border px-3 py-2">Produto</th>
              <th class="border px-3 py-2">Qtd</th>
              <th class="border px-3 py-2">Valor</th>
              <th class="border px-3 py-2">Total</th>
            </tr>
          </thead>
          <tbody class="divide-y divide-gray-200"></tbody>
        </table>
      </div>

      <!-- Desconto -->
      <div>
        <label for="desconto" class="block text-sm font-medium mb-2">Aplicar desconto:</label>
        <select id="desconto" 
                class="w-full border border-gray-300 rounded-lg px-3 py-2 shadow-sm focus:ring-2 focus:ring-orange-400 focus:outline-none">
          <option value="0">Sem desconto</option>
          <option value="5">5% de desconto</option>
          <option value="10">10% de desconto</option>
          <option value="15">15% de desconto</option>
          <option value="20">20% de desconto</option>
        </select>
      </div>

      <!-- BotÃ£o -->
      <button onclick="emitirNota()" 
              class="w-full bg-green-600 text-white font-semibold py-3 rounded-lg shadow hover:bg-green-700 transition">
        Emitir Nota
      </button>
    </div>
  </div>


  <!-- seu script JS -->
  <script>
  const produtos = [];

  function adicionarProduto() {
      const nome = document.getElementById("produtoNome").value;
      const qtd = parseInt(document.getElementById("produtoQtd").value);
      const valor = parseFloat(document.getElementById("produtoValor").value);

      if(!nome || isNaN(qtd) || isNaN(valor)) {
          alert("Preencha corretamente.");
          return;
      }

      produtos.push({ nome, qtd, valor });
      atualizarTabela();

      document.getElementById("produtoQtd").value = "";
      document.getElementById("produtoValor").value = "";
  }

  function preencherValor() {
      const select = document.getElementById("produtoNome");
      const valor = select.options[select.selectedIndex].getAttribute("data-valor");
      document.getElementById("produtoValor").value = valor;
  }

  function atualizarTabela() {
      const tbody = document.querySelector("#tabelaProdutos tbody");
      tbody.innerHTML = "";
      produtos.forEach(p => {
          const tr = document.createElement("tr");
          tr.innerHTML = `<td>${p.nome}</td><td>${p.qtd}</td><td>â‚¬ ${p.valor.toFixed(2)}</td><td>â‚¬ ${(p.qtd*p.valor).toFixed(2)}</td>`;
          tbody.appendChild(tr);
      });
  }

  function emitirNota() {
      if(produtos.length === 0) { alert("Adicione produtos."); return; }

      const clienteNome = document.getElementById("clienteNome").value;
      if(!clienteNome) { alert("Preencha o nome do cliente."); return; }

      const descontoPercentual = parseInt(document.getElementById("desconto").value);

      const { jsPDF } = window.jspdf;
      const doc = new jsPDF({ unit: "mm", format: [80, 200] }); // recibo estreito

      let y = 10;
      doc.setFontSize(12);
      doc.text("MARMITAS", 40, y, { align: "center" });
      y += 5;
      doc.setFontSize(8);
      y += 5;
      doc.text("Rua HorÃ¡cio MarÃ§al 271, Paranhos, Porto", 40, y, { align: "center" });

      y += 5;
      doc.line(5, y, 75, y);

      y += 5;
      doc.setFontSize(10);
      doc.text(`Cliente: ${clienteNome}`, 5, y);

      y += 5;
      doc.line(5, y, 75, y);

      y += 5;
      doc.text("Produto", 5, y);
      doc.text("Qtd", 35, y, { align: "right" });
      doc.text("Valor", 55, y, { align: "right" });
      doc.text("Total", 75, y, { align: "right" });

      y += 2;
      doc.line(5, y, 75, y);
      y += 4;

      let totalGeral = 0;
      produtos.forEach((p, index) => {
        const total = p.qtd * p.valor;
        totalGeral += total;

        y += 2;
        let nomeQuebrado = doc.splitTextToSize(p.nome, 20);
        doc.text(nomeQuebrado, 5, y);
        let linhasUsadas = nomeQuebrado.length;
        let yBase = y + (linhasUsadas - 1) * 4;

        doc.text(p.qtd.toString(), 35, yBase, { align: "right" });
        doc.text(p.valor.toFixed(2), 55, yBase, { align: "right" });
        doc.text(total.toFixed(2), 75, yBase, { align: "right" });

        y = yBase + 5;

        if(index < produtos.length - 1) {
            doc.text("........................................", 5, y);
            y += 4;
        }
      });

      y += 2;
      doc.line(5, y, 75, y);

      y += 5;

      // ðŸ”¹ Aplica desconto se houver
      if(descontoPercentual > 0) {
        const valorDesconto = totalGeral * (descontoPercentual / 100);
        const totalComDesconto = totalGeral - valorDesconto;

        doc.setFontSize(9);
        doc.setFont(undefined, "normal");
        doc.text(`Subtotal: â‚¬ ${totalGeral.toFixed(2)}`, 75, y, { align: "right" });
        y += 5;
        doc.text(`Desconto (${descontoPercentual}%): -â‚¬ ${valorDesconto.toFixed(2)}`, 75, y, { align: "right" });
        y += 6;

        // ðŸ”¹ TOTAL destacado
        doc.setFontSize(12);
        doc.setFont(undefined, "bold");
        doc.text(`TOTAL: â‚¬ ${totalComDesconto.toFixed(2)}`, 75, y, { align: "right" });

      } else {
        // ðŸ”¹ TOTAL destacado sem desconto
        doc.setFontSize(12);
        doc.setFont(undefined, "bold");
        doc.text(`TOTAL: â‚¬ ${totalGeral.toFixed(2)}`, 75, y, { align: "right" });
      }

      // voltar ao estilo normal para rodapÃ©
      y += 6;
      doc.setFontSize(7);
      doc.setFont(undefined, "normal");
      doc.text(`Emitido em: ${new Date().toLocaleString()}`, 5, y);
      y += 5;
      doc.text("Obrigado pela preferÃªncia!", 40, y, { align: "center" });

      const clienteSafe = clienteNome.replace(/[^a-zA-Z0-9]/g, "_");
      doc.save(`nota_marmitas_${clienteSafe}.pdf`);
  }
</script>
</body>
</html>
