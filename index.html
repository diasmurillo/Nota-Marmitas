<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<title>Nota de Marmitas</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    input, button { margin: 5px; padding: 5px; }
    table { border-collapse: collapse; margin-top: 10px; width: 100%; }
    th, td { border: 1px solid #000; padding: 5px; text-align: center; }
</style>
</head>
<body>
<h1>Nota das Marmitas</h1>

<h3>Dados do Cliente</h3>
<input id="clienteNome" placeholder="Nome do Cliente"><br>

<h3>Produto</h3>
<select id="produtoNome">
    <option value="Lentilha">Lentilha</option>
    <option value="Strogonoff">Strogonoff</option>
    <option value="Strogonoff de Frango">Strogonoff de frango</option>
    <option value="Caril de Legumes">Caril de legumes</option>
    <option value="Parmegiana">Parmegiana</option>
    <option value="AlmÃ´ndega">AlmÃ´ndega</option>
    <option value="AlmÃ´ndega Bovina">AlmÃ´ndega Bovina</option>
    <option value="Panqueca">Panqueca</option>
    <option value="Caril de frango">Caril de frango</option>
    <option value="Peito de peru">Peito de peru</option>
</select>
<input id="produtoQtd" placeholder="Quantidade" type="number">
<input id="produtoValor" placeholder="Valor UnitÃ¡rio (â‚¬)" type="number" step="0.01">
<button onclick="adicionarProduto()">Adicionar Produto</button>

<table id="tabelaProdutos">
<thead>
<tr>
<th>Produto</th>
<th>Qtd</th>
<th>Valor</th>
<th>Total</th>
</tr>
</thead>
<tbody></tbody>
</table>

<button onclick="emitirNota()">Emitir Nota PDF</button>

<script>
const produtos = [];

function adicionarProduto() {
    const nome = document.getElementById("produtoNome").value;
    const qtd = parseInt(document.getElementById("produtoQtd").value);
    const valor = parseFloat(document.getElementById("produtoValor").value);

    if(!nome || isNaN(qtd) || isNaN(valor)) {
        alert("Preencha corretamente.");
        return;
    }

    produtos.push({ nome, qtd, valor });
    atualizarTabela();

    document.getElementById("produtoQtd").value = "";
    document.getElementById("produtoValor").value = "";
}

function atualizarTabela() {
    const tbody = document.querySelector("#tabelaProdutos tbody");
    tbody.innerHTML = "";
    produtos.forEach(p => {
        const tr = document.createElement("tr");
        tr.innerHTML = `<td>${p.nome}</td><td>${p.qtd}</td><td>â‚¬ ${p.valor.toFixed(2)}</td><td>â‚¬ ${(p.qtd*p.valor).toFixed(2)}</td>`;
        tbody.appendChild(tr);
    });
}

function emitirNota() {
    if(produtos.length === 0) { alert("Adicione produtos."); return; }

    const clienteNome = document.getElementById("clienteNome").value;
    if(!clienteNome) { alert("Preencha o nome do cliente."); return; }

    const { jsPDF } = window.jspdf;
    const doc = new jsPDF({ unit: "mm", format: [80, 200] }); // recibo estreito

    let y = 10;
    doc.setFontSize(12);
    doc.text("MARMITAS", 40, y, { align: "center" });
    y += 5;
    doc.setFontSize(8);
    y += 5;
    doc.text("Rua HorÃ¡cio MarÃ§al 271, Paranhos, Porto", 40, y, { align: "center" });

    // linha completa
    y += 5;
    doc.line(5, y, 75, y);

    y += 5;
    doc.setFontSize(10);
    doc.text(`Cliente: ${clienteNome}`, 5, y);

    // linha completa
    y += 5;
    doc.line(5, y, 75, y);

    y += 5;
    // CabeÃ§alho
    doc.text("Produto", 5, y);
    doc.text("Qtd", 35, y, { align: "right" });
    doc.text("Valor", 55, y, { align: "right" });
    doc.text("Total", 75, y, { align: "right" });

    // linha completa
    y += 2;
    doc.line(5, y, 75, y);
    y += 4;

    let totalGeral = 0;
    produtos.forEach((p, index) => {
    const total = p.qtd * p.valor;
    totalGeral += total;

    // ðŸ”¹ Adiciona margin top antes do produto
    y += 2; // 2mm de espaÃ§o

    // ðŸ”¹ Quebra o nome do produto em atÃ© 20mm de largura
    let nomeQuebrado = doc.splitTextToSize(p.nome, 20);

    // ðŸ”¹ Escreve o nome (pode ocupar mais de uma linha)
    doc.text(nomeQuebrado, 5, y);

    // ðŸ”¹ A Ãºltima linha do nome vai ser a base para Qtd, Valor e Total
    let linhasUsadas = nomeQuebrado.length;
    let yBase = y + (linhasUsadas - 1) * 4;

    // ðŸ”¹ Cada coluna em posiÃ§Ã£o fixa
    doc.text(p.qtd.toString(), 35, yBase, { align: "right" });
    doc.text(p.valor.toFixed(2), 55, yBase, { align: "right" });
    doc.text(total.toFixed(2), 75, yBase, { align: "right" });

    // AvanÃ§a Y para a prÃ³xima linha de produto
    y = yBase + 5;

    // ðŸ”¹ Pontilhado sÃ³ atÃ© o penÃºltimo produto
    if(index < produtos.length - 1) {
        doc.text("........................................", 5, y);
        y += 4;
    }
});



    // linha completa antes do total
    y += 2;
    doc.line(5, y, 75, y);

    y += 5;
    doc.setFontSize(10);
    doc.text(`TOTAL: â‚¬ ${totalGeral.toFixed(2)}`, 75, y, { align: "right" });

    y += 6;
    doc.setFontSize(7);
    doc.text(`Emitido em: ${new Date().toLocaleString()}`, 5, y);
    y += 5;
    doc.text("Obrigado pela preferÃªncia!", 40, y, { align: "center" });

    // Remove caracteres que podem dar problema em nomes de arquivo
    const clienteSafe = clienteNome.replace(/[^a-zA-Z0-9]/g, "_");
    doc.save(`nota_marmitas_${clienteSafe}.pdf`);

}
</script>
</body>
</html>
